package sax;

import java.io.File;
import java.io.FileInputStream;
import java.util.ArrayList;

import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.xml.sax.Attributes;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;
import org.xml.sax.ext.LexicalHandler;
import org.xml.sax.helpers.DefaultHandler;

public class SqliteManager extends DefaultHandler implements LexicalHandler{
	
    private static final String BODY = "body";
	//static String displayText[] = new String[2500];
	static ArrayList<String> xmlBuffer = new ArrayList<String>();
	  
   
    static boolean isBody = false;
    static String cdata = "";
    static String div ="div";
    static boolean isChapter = false;
    static int chapterOpened = 0;
    
    public static void main(String args[])
    {
    	SqliteManager obj = new SqliteManager();
        
       	obj.teiToSqlite("voisin_defense_1671.xml");
       
              
    }

    public void teiToSqlite(String uri)
    {
        DefaultHandler handler = this;
        SAXParserFactory factory = SAXParserFactory.newInstance();
        try {
            SAXParser saxParser = factory.newSAXParser();
            InputSource is = new InputSource(new FileInputStream(new File(uri)));
            is.setEncoding("UTF-8");
            saxParser.setProperty("http://xml.org/sax/properties/lexical-handler",
            	       this);
            saxParser.parse(is, handler);
          
           // saxParser.parse(new File(uri), handler);
        } catch (Exception e) {
        	e.printStackTrace();
        }
    }

    public void startDocument()
    {
    	xmlBuffer.add( "<?xml version=\"1.0\" encoding=\""+"UTF-8" + "\"?>\n");
//        displayText[numberLines] = "";
//        displayText[numberLines] += "<?xml version=\"1.0\" encoding=\""+
//            "UTF-8" + "\"?>\n";
        
    }

    public void processingInstruction(String target, String data)
    {
    	String text = "";

    	
      text = "";
      text += "<?";
      text += target;
      if (data != null && data.length() > 0) {
    	  text += ' ';
    	  text += data;
      }
      text += "?>";
      xmlBuffer.add(text);
     
    }

    public void startElement(String uri, String localName,
        String qualifiedName, Attributes attributes)
    {
    	if(qualifiedName.equals(BODY)){
    		isBody = true;
    	}
    	
    	String text = "";
      
    	text = "";
    	text += '<';
    	text += qualifiedName;
        if (attributes != null) {
            int numberAttributes = attributes.getLength();
            for (int loopIndex = 0; loopIndex < numberAttributes; loopIndex++){
            	text += ' ';
            	text += attributes.getQName(loopIndex);
            	text += "=\"";
            	text += attributes.getValue(loopIndex);
            	text += '"';
            	
            	if(qualifiedName.equalsIgnoreCase(div)
            			&& (attributes.getQName(loopIndex).equalsIgnoreCase("type")
            			&& (attributes.getValue(loopIndex).equalsIgnoreCase("article")
            			|| attributes.getValue(loopIndex).equalsIgnoreCase("chapter")))){
            		isChapter = true;
            		
            	}
            }
        }
        text += '>';
        
        xmlBuffer.add(text);
       if(isChapter && qualifiedName.equalsIgnoreCase(div)){
    	   chapterOpened ++;
    	   System.out.println(text + " "+isChapter+" "+chapterOpened);
    	   
       }
       
       
       
    }
    
//    public void writeCData(){
//    	
//    	String text = "";
//   
//    	String newCData = cdata;
//    	/*if(cdata.indexOf("\n") < 0 && cdata.length() > 0 && isBody) {
//    		newCData = TextAnnotator.annotateText(cdata);
//    	}*/
//    	
////    	displayText[numberLines] = "";
////            displayText[numberLines] += newCData;
//    	
//    	text += newCData;
//    	text = text.replace("&", "&amp;");
//    	 xmlBuffer.add(text);
//           
////            if(cdata.indexOf("\n") < 0 && cdata.length() > 0) {
////            System.out.println(cdata);
////           
////            }
//           
//           
//    }

    public void characters(char characters[], int start, int length)
    {
        String characterData = (new String(characters, start, length));
      	
        if(isChapter){
        	 cdata = cdata + characterData;
        }
       
        
             
    }
    
   
    public void ignorableWhitespace(char characters[], int start, int length)
    {
        characters(characters, start, length);
    }

    public void endElement(String uri, String localName, String qualifiedName)
    {
    	String text = "";
    	      
//    	displayText[numberLines] = "";
//        displayText[numberLines] += "</";
//        displayText[numberLines] += qualifiedName;
//        displayText[numberLines] += '>';
    	if(qualifiedName.equalsIgnoreCase(div) && isChapter){
    		chapterOpened --;
    	}
    	if(qualifiedName.equalsIgnoreCase(div) && chapterOpened == 0){
    		isChapter = false;
    		System.out.println(cdata);
    		cdata = "";
    		System.out.println("closed chapter with xml id "+chapterOpened);
    	}
    	
    	text = "";
    	text += "</";
    	text += qualifiedName;
    	text += '>';
    	xmlBuffer.add(text);
        

    }

    public void warning(SAXParseException exception)
    {
        System.err.println("Warning: " +
            exception.getMessage());
    }

    public void error(SAXParseException exception)
    {
        System.err.println("Error: " +
            exception.getMessage());
    }

    public void fatalError(SAXParseException exception)
    {
        System.err.println("Fatal error: " +
            exception.getMessage());
    }

	@Override
	public void comment(char[] characters, int start, int length) throws SAXException {
		String characterData = (new String(characters, start, length));
      	//displayText[numberLines] = "";
      	//xmlBuffer.add("");
        //cdata = cdata + characterData;
		//System.out.println("comment "+characterData);
		xmlBuffer.add("\n<!--"+characterData+"-->");
      
        //newCData = true;
		
	}

	@Override
	public void endCDATA() throws SAXException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void endDTD() throws SAXException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void endEntity(String arg0) throws SAXException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void startCDATA() throws SAXException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void startDTD(String arg0, String arg1, String arg2)
			throws SAXException {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void startEntity(String arg0) throws SAXException {
		// TODO Auto-generated method stub
		
	}

}
